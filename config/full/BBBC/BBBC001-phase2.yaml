# polus-plugins workflow definition
# dependencies between steps are defined by links between inputs and outputs
# for each steps and will be appropriately generated by wic.
name: viz_workflow_BBBC001_phase2
steps:
    - bbbcdownload:
        plugin:
            name: "BbbcDownload"
            manifest: "https://raw.githubusercontent.com/saketprem/polus-plugins/bbbc_download/utils/bbbc-download-plugin/plugin.json"
        params:
            name: "BBBC001"
    - filerenaming:
        plugin:
            name: "FileRenaming"
            manifest: "https://raw.githubusercontent.com/PolusAI/polus-plugins/f20a2f75264d59af78cfb40b4c3cec118309f7ec/formats/file-renaming-plugin/plugin.json"
        params:
            inpDir:
                type: Path
                link: BbbcDownload.outDir
            filePattern: ".*_{row:c}{col:dd}f{f:dd}d{channel:d}.tif"
            outFilePattern: "d{directory:dd}_x{row:dd}_y{col:dd}_p{f:dd}_c{channel:d}.tif"
            mapDirectory: "raw"
    - omeconverter:
        plugin:
            name: "OmeConverter"
            manifest: "https://raw.githubusercontent.com/PolusAI/polus-plugins/a2666916628ab8e7d04e87d866f9b7835a86ef55/formats/ome-converter-plugin/plugin.json"
        params:
            inpDir:
                type: Path
                link: FileRenaming.outDir
            filePattern: ".*.tif"
            fileExtension: ".ome.tif"
    - flatfield_estimate:
        plugin:
            name: "BasicFlatfieldEstimation"
            manifest: "https://raw.githubusercontent.com/PolusAI/polus-plugins/master/regression/basic-flatfield-estimation-plugin/plugin.json"
        params:
            inpDir:
                type: Path
                link: OmeConverter.outDir
            filePattern: "d00_x00_y03_p{p:dd}_c0.ome.tif"
            groupBy: "p"
            outDir:
                type: Path
                path: "BBBC/BBBC001_out"
            getDarkfield: "True"
    - flatfield_apply:
        plugin:
            name: "ApplyFlatfield"
            manifest: "https://raw.githubusercontent.com/PolusAI/polus-plugins/master/transforms/images/apply-flatfield-plugin/plugin.json" 
        params:
            imgDir:
                type: Path
                link: OmeConverter.outDir
            imgPattern: "d00_x00_y03_p{p:dd}_c0.ome.tif"
            ffDir:
                type: Path
                link: BasicFlatfieldEstimation.outDir
            ffPattern: "d00_x00_y03_p{p:dd}_c0_flatfield.ome.tif"
            dfPattern: "d00_x00_y03_p{p:dd}_c0_darkfield.ome.tif"
    - montage:
        plugin:
            name: "Montage"
            manifest: "https://raw.githubusercontent.com/PolusAI/polus-plugins/master/transforms/images/montage-plugin/plugin.json"
        params:
            inpDir:
                type: Path
                link: ApplyFlatfield.outDir
            filePattern: "d00_x00_y03_p{p:dd}_c0.ome.tif"
            layout: "p"
    - image_assembler:
        plugin:
            name: "ImageAssembler"
            manifest: "https://raw.githubusercontent.com/agerardin/polus-plugins/new/image-assembler-plugin-1.4.0-dev0/transforms/images/image-assembler-plugin/plugin.json"
        params:
            imgPath:
                type: Path
                link: OmeConverter.outDir
            stitchPath:
                type: Path
                link: Montage.outDir
    - precompute_slide:
        plugin:
            name: "PrecomputeSlide"
            manifest: "https://raw.githubusercontent.com/agerardin/polus-plugins/update/precompute-slide-fp2/visualization/precompute-slide-plugin/plugin.json"
        params:
            inpDir:
                type: Path
                link: ImageAssembler.outDir
            pyramidType: "Zarr"
            imageType: "image"
            outDir:
                type: Path
                path: "BBBC/BBBC001_out"
